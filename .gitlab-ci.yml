workflow:
  rules:
    - if: '$CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "main"'
    - when: never

stages:
  - build
  - test

variables:
  CONTAINER_TEST_IMAGE: $CI_REGISTRY_IMAGE:$CI_COMMIT_REF_SLUG
  GOTEST: "go test ./... -v"

before_script:
  # Login to the Docker registry before any job begins
  - echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" --password-stdin $CI_REGISTRY

build:
  stage: build
  image: docker:20.10.7 # Using the official Docker image with native Docker CLI
  script:
    - echo "Building the Docker image using docker build"
    - docker build --pull -t $CONTAINER_TEST_IMAGE .
    - docker push $CONTAINER_TEST_IMAGE
  only:
    - branches
    - merge_requests

test:
  stage: test
  image: docker:20.10.7  # Use the official Docker image to run tests
  script:
    - echo "Pulling the Docker image for tests"
    - docker pull $CONTAINER_TEST_IMAGE
    - echo "Running tests inside the Docker container"
    - docker run -i --rm -v /builds/NGWPC/flows2fim:/app $CONTAINER_TEST_IMAGE sh -c "pwd && ls -al /app && $GOTEST"
  only:
    - branches
    - merge_requests
